overlay: 1.0.0
info:
  title: Service extension
  description: this overlay adds changes for supporting Service entities to the SKG-IF API
  version: 1.0.0
#
# this overlay file will potentially add the folowing modifications next to
# adding changes for  Service class
# (1) add FacilityPortal class to model information about place & organisation that facilitates the service
# (2) modify Venue core entity, with a new type "portal" allowing Venue to model information about place and organisation facilitating the service
# (3) modify Organisation core entity with new organisation types, allowing modelling of information about place and organisation facilitating the service via the "relevant_organisations" property. this does not determine the role of the organisation is this specific relation, but only suggests it.
# (4) add a new "related_organisations" property folowing  "related_products". with the folwing relation types: "research_infrastructure", "portal", "hosting_legal_entity" and "other". this allows more deterministic to specify a specific relation between a service and organisation.
# (5) use two separate properties: "research_infrastructure" and "hosting_legal_entity" to model the roles of organisations in managing & operating the service
# option (4) makes (3) superfluous since it allows relations of type "other"
# option (5) is semanticaly more accurate than option (3)
# for now v1.0.0 enables option (2) and (5) 
  
actions:
  - target: $.tags
    update:
      - name: Service
        description: service operations (skg-if srv extension)
  - target: $.paths
    update:
      '/services':
        get:
          tags:
            - Service
          summary: Get list of service. 
          operationId: getServices
          description: |
              Get a list of `service`. See definition in SKG-IF [Service] (https://skg-if.github.io/interoperability-framework/docs/service.html) (entity_type: service ).

              __Attribute filters__ \
              You can filter using these attributes of the `service` object
              | Filter key| Attribute filter example |
              | -------- | -------- |
              | identifiers.id | `identifiers.id:https://hdl.handle.net/11234/1-1702` |
              | name | `name:UDPIpe` |
              | website | `website:https://ufal.mff.cuni.cz/udpipe` |
              | country | `country:CZ` |

              __Convenience filters__ \
              These filters aren't attributes of the `organization` object, but they're handy for solving some common use cases.

              | Filter key | Filter value | List returned | Attribute filter example |
              | -------- | -------- | ------- | ------- |
              | cf.search.name | a string | `organisation` with name containing the filter value | `cf.search.name:UFAL` |

              __Query parameter syntax examples__ \
    
               * `/services?filter=identifiers.scheme:ror,identifiers.id:11234/1-1702`
               * `/services?filter=cf.search.name:UDPipe`
               * `/services?filter=cf.search.name:UDPipe&page=1&page_size=5`
# refine the last exmple into one really needing multiple pages

          parameters:    
            - $ref : '#/components/parameters/filterQueryParam'
          responses:
            '200':
              description: Success
              content:
                application/json:
                  schema:
                    properties:
                      "@context":
                        type: array
                        description: JSON-LD context # not displayed in Stoplight elements
                        minItems: 4 # http://../skg-if.json, http://../skg-if-api.json, http://../skg-if-ext-serv.json and @base
                        uniqueItems: true
                        items:
                          anyOf:
                            - $ref: '#/components/schemas/JsonLdCtxDataModel'
                            - $ref: '#/components/schemas/JsonLdCtxSearch'
                            - $ref: '#/components/schemas/JsonLdCtxBaseOrMore'
                            - $ref: '#/components/schemas/JsonLdCtxExt-srv'
                        examples:
                          - ["https://w3id.org/skg-if/context/1.1.0/skg-if.json", "https://w3id.org/skg-if/context/1.0.0/skg-if-api.json", {"@base": "https://w3id.org/skg-if/sandbox/my-skg-acronym/"}, "https://w3id.org/skg-if/extension/srv/context/skg-if.json"]
#add the 4th JsonLdCtx
                      meta:
                        type: object
                        $ref: '#/components/schemas/Meta'
                      "@graph":
                          type: array
                          items:     
                            $ref: '#/components/schemas/Service'
                    required: [ "@context", "meta", "@graph" ]
                    
  - target: $.paths
    update:
      '/services/{short_local_identifier}':
        get:
          tags:
            - Service
          summary: Get service by id
          description: |
              Get a single `service`. See definition in SKG-IF extension [Service](https://skg-if.github.io/interoperability-framework/docs/service.html) ( entity_type:service ).
          operationId: getServiceById
          parameters:
              - $ref : '#/components/parameters/shortLocalIdPathParam'
          responses:
            '200':
              description: Success
              content:
                # not 'application/json-ld' to be compatible with StopLight PRISM tool
                application/json: 
                  schema:
                    required: ["@context", "@graph"]
                    properties:
                      "@context":
                         type: array
                         description: JSON-LD context # not displayed in Stoplight elements
                         minItems: 4 # http://../skg-if.json, http://../skg-if-api.json, http://../skg-if-ext-serv.json and @base
                         uniqueItems: true
                         items:
                            anyOf:
                              - $ref: '#/components/schemas/JsonLdCtxDataModel'
                              - $ref: '#/components/schemas/JsonLdCtxSearch'
                              - $ref: '#/components/schemas/JsonLdCtxBaseOrMore'
                              - $ref: '#/components/schemas/JsonLdCtxExt-srv'
                         examples:
                           - ["https://w3id.org/skg-if/context/1.1.0/skg-if.json", "https://w3id.org/skg-if/context/1.0.0/skg-if-api.json", {"@base": "https://w3id.org/skg-if/sandbox/my-skg-acronym/"}, "https://w3id.org/skg-if/extension/srv/context/skg-if.json"]
                      "@graph":
                        type: array
                        minItems: 1
                        maxItems: 1
                        items:
                          $ref: "#/components/schemas/Service"

  - target: $.components.parameters
    update:
      filterQueryParam: # filterQueryParam duplicated in each search endpoint ( only way to add distinct examples for each endpoint )
        name: filter
        in: query
        description: |
            Search filter. Format : Coma separated filter_name:filter_value elements ( filter_name_1:filter_value_1,filter_name_2:filter_value_2,filter_name_3:filter_value_3... ). Server side operator used is _AND_.
        schema:
          type: string
          pattern: '^(,?.+:.+)*$'

  - target: $.components.schemas
    update:
      JsonLdCtxExt-srv:
        type: string
        description: "URL to SKG-IF service extension data model context"
        enum:
          - https://w3id.org/skg-if/extension/srv/context/skg-if.json
        x-faker:
          fake: ['https://w3id.org/skg-if/extension/ra-skg/context/skg-if.json']

      Service:
        type: object
        title: 'Service'
        description:  "`service` object. See definition in SKG-IF [Service](https://skg-if.github.io/...) ( entity_type:service )."
        allOf:
          - $ref: "#/components/schemas/Entity"
          - type: object
            required: [
              "local_identifier","entity_type"
            ]        
            properties:
              entity_type:  # was already specified?
                type: string
                default: "service"
                x-faker:
                  fake: ["service"]
              identifiers:
                type: array
                items:
                  properties:
                    scheme: 
                      type: string
                      x-faker: 
                        helpers.arrayElement: [["url"]]
                      examples:
                        - "ELG catalogue"
                    value: 
                      type: string
                      x-faker:
                        fake : ['{{internet.url}}/record/{{random.alphaNumeric(8)}}']
                      examples:
                        - "https://live.european-language-grid.eu/catalogue/tool-service/18189"
              name:
                type: array
                description: The names of a [service] (multiple for multilingualism)
              # simplified compared to earlier spec, no iso-639-1  qualified strings
                items:
                  type: string
                examples:
                  - ["UDPipe", "UDPipe 工具"]

              description:
                type: object
                description: |
                  The descriptions of a `service` (multiple for multilinguism).\
                  The object is a dictionary, the keys represent language codes following [ISO 639-1](https://en.wikipedia.org/wiki/ISO_639-1).\
                  The special key `none` is reserved whenever the information about the language is not available or cannot be shared.
                patternProperties:
                  "^([a-z]{2}|none)$":
                    type: array
                    items:
                      type: string
                      x-faker:
                       random.words: [ 20 ]
                examples:
                   - {"en": ["UDPipe 2 is a Python prototype, capable of performing tagging, lemmatization and syntactic analysis of CoNLL-U input. It took part in several competitions, reaching excellent results in all of them", "Summary"]}

              audience_byrole:
                description:  The audience(s) for which the service is intended to be used. This can  both express desire and/or design of the service operators. Values are defined in "https://vocabs.sshopencloud.eu/vocabularies/sshoc-audience/audienceScheme", and should be used with prefix "sshocaudience" defined in the context.
                type: array
                items:
                  type: string
                  pattern: "^sshocaudience:[A-Za-z0-9._-]+$"
                examples:
                  - ["sshocaudience:public", "sshocaudience:student" ]

              audience_byjurisdiction:
                description: The jurisdiction that is given by the service operator's legal status limits the audience. POtential values are from Global, Institution, National, or Regional aka multiple countries, from https://zenodo.org/records/15516020
                type: string
                enum: ["Global", "Institution", "National", "Regional"]
                examples: 
                  - ["National"]
#TODO
#              disciplines:

              is_accessible_for_free:
                description: A property to flag that the Service is accessible for free, in the academic world most services are free or have a free modus
                type: boolean
                default: true

              invocation_type:
                type: array
                description:  The way the service is used or called. multiple values are possible, access rights and licenses are assumed to be the same, the property values are defined in "https://vocabs.sshopencloud.eu/vocabularies/invocation-type/" and should be used with the prefix "sshocinvt" defined in the context.
                items:
                  type: string
                  pattern: "^sshocinvt:[A-Za-z0-9._-]+$"
                examples:
                  - ["sshocinvt:restfullWebservice", "sshocinvt:webApplication" ]

              life_cycle_status:
                type: array
                description: indicates the development cycle and/or maturity status of the service, the property values are defined in the skos schema "https://vocabs.sshopencloud.eu/vocabularies/eosc-life-cycle-status/" and should be used with the prefix "elcs" defined in the context.
                items:
                  type: string
                  pattern: "^elcs:[A-Za-z0-9._-]+$"
                examples:
                  - ["elcs:life_cycle_status_production", "elcs:TRL6" ]

              website:
                 type: string
                 description: The landingpage or website URL for a Service.
                 examples:
                   - "https://ufal.mff.cuni.cz/udpipe"

              availability_geographic:
                type: array
                description: list of countries and regions where the service is available, the property values are defined in the skos schema "https://vocabs.sshopencloud.eu/vocabularies/eosc-geographical-availability" and should be used with the prefix "eoscgeoavail"  defined in the context.
                items:
                  type: string
                  pattern: "^eoscgeoavail:[A-Za-z0-9._-]+$"
                examples:
                  - ["eoscgeoavail:eu", "eoscgeoavail:uk"]
              supported_language:
                type: array
                description: The languages supported by the service
                items:
                  type: string
                  pattern: "^([a-z]{2}|none)$"
                examples:
                   - ["en", "nl"]

              deployment_of:
                type: array
                description: Research Product of type software, software class or sourcecode repository link that the service is based on.
                items:
                  type: object
                  required: ["@id", "@type"]
                  properties:
                    "@id":
                      type: string
                      format: uri
                      description: IRI identifying the service software 
                    "@type":
                      type: string
                      description: >
                        RDF type of the referenced service software, expressed as a CURIE
                        (e.g. schema:SoftwareSourceCode, skg:research_product)
                      pattern: "^[A-Za-z][A-Za-z0-9._-]*:[A-Za-z0-9._-]+$"
                examples:
                  -  [ { "@id": "https://github.com/ufal/udpipe", "@type": "schema:SoftwareSourceCode"}, { "@id": "http://example.org/research_product/RP_101", "@type": "skg:research_product"} ]

              has_hosting_legal_entity:
                description: organisation (legal entity) legally responsible for the hosted service
                $ref: '#/components/schemas/Organisation'
                example:
                  - local_identifier: https://ror.org/024d6js02
                    entity_type: 'organisation'
                    name: "Charles University"
                    types: [education, research]
                    country: CZ

              has_hosting_organisation:
                type: array
                description: organisation responsible for hosting and operating the service
                items:
                  $ref: '#/components/schemas/Organisation'
                example:
                  - local_identifier: https://ror.org/00dd4fz34
                    entity_type: 'organisation'
                    name: "Digital Research Infrastructure for Language Technologies, Arts and Humanities"
                    short_name: "LINDAT"
                    types: [facility]
                    country: CZ
                
              has_research_infrastructure:
                type: array
                description: research infrastructure organisation(s) involved
                items:
                  $ref: '#/components/schemas/Organisation'
                example:
                  - local_identifier: https://ror.org/03wp25384
                    entity_type: 'organisation'
                    identifiers:
                      - scheme: ror
                        value: https://ror.org/03wp25384
                    name: "CLARIN ERIC"
                    types: [facility, research_infrastructure]
                    country: NL

              has_venue:
                description: provide reference to portal/venue through which the serice is advertised (catalogue) and accessible.
                $ref: '#/components/schemas/Venue'
                example:
                  - local_identifier: venue_identifier1
                    entity_type: 'venue'
                    name: "EOSC node"
                    types: [portal]
                  
                
              related_products:
                description: mainly used for noting citation of the use of services, non-local identifiers can be used for external references.
                $ref: '#/components/schemas/ProductRelated'
                examples:
                  - cites: ["10.18653/v1/k17-3009", "10.30564/fls.v6i5.6957", "10.18653/v1/k18-2020"]

              "dcterms:conformsto":
                description: iri of the api profile/standard, either simple link or complex (embedded) structure
                anyofapi:
                  - type: string
                    format: uri
                  - $ref: "#/components/schemas/apiprofile"
                example:
                  - "https://lindat.mff.cuni.cz/services/udpipe/api-reference.php"


              relevant_organisations:
                type: array
                description: list of relevant organisation  associated with the `service`, in case the individual affiliations of a `person` do not fit the contribution or are not available.
                items:
                  $ref: '#/components/schemas/Organisation'
                example:
                  - local_identifier: https://ror.org/00dd4fz34
                    entity_type: organisation
                    name: "digital research infrastructure for language technologies, arts and humanities"
                    short_name: "lindat"
                    types: [facility]
                    country: CZ
                  - local_identifier: https://ror.org/024d6js02
                    entity_type: organisation
                    name: "charles university"
                    types: [education, research]
                    country: CZ
                  - local_identifier: https://ror.org/03wp25384
                    entity_type: organisation
                    name: "clarin eric"
                    types: [facility, research_infrastructure]
                    country: NL

#some additional organisation types should be added, see below

      apiprofile:
        type: object
        description: api profile (endpoint + one or more spec document urls).
        required: ["dcat:endpointurl", "schema:url"]
        properties:
          "dcat:endpointurl":
            minitems: 1
            maxitems: 1
            type: array
            items:
              type: string
              format: uri
          "schema:url":
            type: array
            minitems: 1
            items:
              type: string
              format: uri
        example: 
          "dcat:endpointurl":
            - "https://lindat.mff.cuni.cz/services/udpipe/api/process"
          "schema:url":
            - "https://lindat.mff.cuni.cz/services/udpipe/"
            - "https://lindat.mff.cuni.cz/services/udpipe/api-reference.php"
            - "https://ufal.mff.cuni.cz/udpipe"

  - target: $.components.schemas.service
#
# facilityportal is a special facilityportal class to model place and organisation facilitation a service
# alternatively this can be done by adding types to venue and/or organisation
#
    update:
      FacilityPortal:
        type: object
        description: FacilityPortal is the organization & facility that operates services and provides portal access to the service
        website:
          type: string
          description: The homepage or website URL the FacilityPortal.
          examples:
            - https://www.diamond.ac.uk/Instruments.html
            - https://www.hpc.cam.ac.uk/
            - https://gate.ac.uk
            - https://cdh.uu.nl/about/humanities-it-services/
        provider: 
          minItems: 1 

  - target: $.components.schemas.Venue.allOf[1].properties.type.enum
#adapting 'Venue' can also model 'Portal' functionality
#add "portal" as a Venue type
    update:
        - portal
  - target: $.components.schemas.Venue.allOf[1].properties
    update:
      services:
        type: array
        items:
          $ref: '#/components/schemas/Service'

  - target: $.components.schemas.Organisation.allOf[1].properties.types.items.enum
#additional organisation types should be provided for modelling support and operating services
# archive , company , education , facility , government , healthcare , nonprofit , funder , research , unspecified with types: infrastructure, hosting-entity ( see EOSC profiles, prefer use legal-entity names if relevant)
#there seems no problem modeling a tool/service(s) as organisation ie. frapo defines facility as "A place or installation built or designed to serve a specific function or provide a specific service, for example an animal breeding centre, a DNA sequencing facility or a confocal imaging laboratory."
# portal -> dcat:Catalog ( lacking supporting facilities and expertise offering)
# facility -> frapo:Facility (is already used in skg-if organisation)
# hosting-legal-entity/provider/operator -> eosc-profiles (v5) hostingLegalEntity
# research-infrastructure -> organisation that provides facilities, resources and services for the research communities to conduct research
# note frapo lacks: (software) service, (research) infrastructure etc.
# EOSC profiles v5 and dcat offers match
    update:
      - portal
      - research_infrastructure
      - hosting_organisation

